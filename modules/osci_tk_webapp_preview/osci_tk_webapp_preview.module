<?php

function osci_tk_webapp_preview_menu() {

	$items['admin/osci/webapp'] = array(
        'title'             => 'Web App',
        'page callback'     => 'drupal_get_form',
        'page arguments'    => array('osci_tk_webapp_admin_form'),
        'access arguments'  => array('administer osci toolkit'),
        'type'              => MENU_LOCAL_TASK,
        'file'              => 'osci_tk_webapp.admin.inc',
    );

	$items['node/%node/web-app'] = array(
		'title'             => 'OSCI Toolkit Web-App Preview',
		'page callback'     => 'osci_tk_webapp_preview',
		'page arguments'    => array(1),
		'access arguments'  => array('access content'),
		'type'              => MENU_LOCAL_TASK
	);

	return $items;
}

function osci_tk_webapp_preview_theme() {

	global $base_path;

	$libPath = $base_path . libraries_get_path('OSCI-Toolkit-Frontend');
	$osci_tk_version = '0.1.0';

	drupal_static_reset('drupal_add_js');
	drupal_static_reset('drupal_add_css');

	$basePath = variable_get('osci_tk_webapp_base_path', '');
	//Add the JS files
	drupal_add_js($basePath . );
	drupal_add_js($basePath . "js/external/json2.js");
	drupal_add_js($basePath . "js/external/jquery-1.7.1.js");
	drupal_add_js($basePath . "js/external/jquery.qtip.js");
	drupal_add_js($basePath . "js/external/underscore-1.4.3.js");
	drupal_add_js($basePath . "js/external/backbone.js");
	drupal_add_js($basePath . "js/external/backbone-super.js");
	drupal_add_js($basePath . "js/external/fancybox/jquery.fancybox.js");
	drupal_add_js($basePath . "js/external/polymaps.min.js");
	drupal_add_js($basePath . "js/external/jquery-ui-1.8.23.custom.min.js");
	drupal_add_js($basePath . "js/oscitk/osci_tk_layered_image.js");
	drupal_add_js($basePath . "js/oscitk/OsciTk.js");
	drupal_add_js($basePath . "js/oscitk/TemplateManager.js");
	drupal_add_js($basePath . "js/oscitk/models/BaseModel.js");
	drupal_add_js($basePath . "js/oscitk/models/ConfigModel.js");
	drupal_add_js($basePath . "js/oscitk/models/PackageModel.js");
	drupal_add_js($basePath . "js/oscitk/models/FigureModel.js");
	drupal_add_js($basePath . "js/oscitk/models/FootnoteModel.js");
	drupal_add_js($basePath . "js/oscitk/models/NavigationItemModel.js");
	drupal_add_js($basePath . "js/oscitk/models/NoteModel.js");
	drupal_add_js($basePath . "js/oscitk/models/SearchResultModel.js");
	drupal_add_js($basePath . "js/oscitk/models/AccountModel.js");
	drupal_add_js($basePath . "js/oscitk/models/PageModel.js");
	drupal_add_js($basePath . "js/oscitk/models/SectionModel.js");
	drupal_add_js($basePath . "js/oscitk/models/GlossaryTermModel.js");
	drupal_add_js($basePath . "js/oscitk/collections/BaseCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/FiguresCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/NavigationItemsCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/FootnotesCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/NotesCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/PagesCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/SearchResultsCollection.js");
	drupal_add_js($basePath . "js/oscitk/collections/GlossaryTermsCollection.js");
	drupal_add_js($basePath . "js/oscitk/views/BaseView.js");
	drupal_add_js($basePath . "js/oscitk/views/AppView.js");
	drupal_add_js($basePath . "js/oscitk/views/SectionView.js");
	drupal_add_js($basePath . "js/oscitk/views/PageView.js");
	drupal_add_js($basePath . "js/oscitk/views/MultiColumnSectionView.js");
	drupal_add_js($basePath . "js/oscitk/views/MultiColumnPageView.js");
	drupal_add_js($basePath . "js/oscitk/views/MultiColumnFigureView.js");
	drupal_add_js($basePath . "js/oscitk/views/MultiColumnFigureImageView.js");
	drupal_add_js($basePath . "js/oscitk/views/MultiColumnFigureLayeredImageView.js");
	drupal_add_js($basePath . "js/oscitk/views/TitleView.js");
	drupal_add_js($basePath . "js/oscitk/views/ToolbarView.js");
	drupal_add_js($basePath . "js/oscitk/views/ToolbarItemView.js");
	drupal_add_js($basePath . "js/oscitk/views/NavigationView.js");
	drupal_add_js($basePath . "js/oscitk/views/SearchView.js");
	drupal_add_js($basePath . "js/oscitk/views/NotesView.js");
	drupal_add_js($basePath . "js/oscitk/views/InlineNotesView.js");
	drupal_add_js($basePath . "js/oscitk/views/CitationView.js");
	drupal_add_js($basePath . "js/oscitk/views/FootnotesView.js");
	drupal_add_js($basePath . "js/oscitk/views/FiguresView.js");
	drupal_add_js($basePath . "js/oscitk/views/GlossaryView.js");
	drupal_add_js($basePath . "js/oscitk/views/GlossaryTooltipView.js");
	drupal_add_js($basePath . "js/oscitk/views/TocView.js");
	drupal_add_js($basePath . "js/oscitk/views/AccountView.js");
	drupal_add_js($basePath . "js/oscitk/views/FontView.js");
	drupal_add_js($basePath . "js/oscitk/views/ParagraphControlsView.js");
	drupal_add_js($basePath . "js/oscitk/Router.js");
	drupal_add_js($basePath . "js/oscitk/helper.js");
	drupal_add_js($basePath . "js/appBootstrap.js");
	drupal_add_js($basePath . "js/oscitk/zotero.js");

	//Add the CSS files
	drupal_add_css($basePath . "js/external/jquery-ui.custom.css");
	drupal_add_css($basePath . "js/external/jquery.qtip.css");
	drupal_add_css($basePath . "js/external/fancybox/jquery.fancybox.css");
	drupal_add_css($basePath . "css/common.css");
	drupal_add_css($basePath . "css/toolbar.css");
	drupal_add_css($basePath . "css/section.css");
	drupal_add_css($basePath . "css/multiColumnSection.css");
	drupal_add_css($basePath . "css/search.css");
	drupal_add_css($basePath . "css/navigation.css");
	drupal_add_css($basePath . "css/notes.css");
	drupal_add_css($basePath . "css/glossary.css");
	drupal_add_css($basePath . "css/layered_image.css");
	drupal_add_css($basePath . "css/citation.css");
	drupal_add_css($basePath . "css/themeNight.css");
	drupal_add_css($basePath . "css/themeSepia.css");

	module_invoke_all("osci_tk_webapp_custom");

	return array(
		'osci_tk_webapp_preview' => array(
			'variables' => array(
				'package_path' => NULL,
				'section_id' => null,
				'endPoints' => array(
					'OsciTkNote' => variable_get('osci_tk_webapp_note_endpoint', ''),
					'OsciTkSearch' => variable_get('osci_tk_webapp_search_endpoint', ''),
					'OsciTkOpenSearch' => variable_get('osci_tk_webapp_opensearch_endpoint', ''),
					'OsciTkAccount' => variable_get('osci_tk_webapp_account_endpoint', ''),
					'OsciTkCitation' => variable_get('osci_tk_webapp_citation_endpoint', ''),
				),
				'templatePath' => variable_get('osci_tk_webapp_template_path', ''),
				'toolbarItems' => variable_get('osci_tk_webapp_toolbar_items', ''),
				'sectionView' => variable_get('osci_tk_webapp_section_view', ''),
				'sectionViewOptions' => variable_get('osci_tk_webapp_section_view_options', ''),
				'paragraphControls' => variable_get('osci_tk_webapp_paragraph_controls','')
			),
			'template'  => 'templates/osci-tk-webapp-preview',
		),
	);
}

function osci_tk_webapp_preview($node) {

	$pubNid = $node->nid;
	$treeData = osci_tk_nodetree_get_data_for_nid($node->nid);
	if (count($treeData) && isset($treeData[0]['rootNid'])) {
		$pubNid = $treeData[0]['rootNid'];
	}

    $packageUri = url('api/epub/' . $pubNid . '/package.opf');

    print theme('osci_tk_webapp_preview', array(
    	'package_path' => $packageUri,
    	'section_id' => ($pubNid === $node->nid) ? null : $node->nid
    ));

    drupal_exit();
}
