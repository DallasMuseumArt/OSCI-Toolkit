/*
 * OSCI Toolkit - v0.1.0 - 2012-05-02
 * http://oscitoolkit.org/
 * Copyright (c) 2010-2012 The Art Institute of Chicago and the Indianapolis Museum of Art
 * GNU General Public License
 */
function getAttributeByLanguage(a){var b=[];for(var c=0;c<a.length;c++)(!a[c].lang||a[c].lang&&a[c].lang==tap.language)&&b.push(a[c]);return b.length===0&&(b=a),b}function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function objectToArray(a){if(a===undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}if(a.nodeType===Node.TEXT_NODE)c=a.nodeValue.replace(/^\s+|\s+$/g,"");else{if(a.nodeType===1&&a.attributes.length>0){var e;c={};for(d=0;d<a.attributes.length;d++)e=a.attributes.item(d),c[e.nodeName.replaceArray(b,"").toCamel()]=e.nodeValue}if(a.hasChildNodes()){var f,g,h;c===!0&&(c={});for(d=0;d<a.childNodes.length;d++){h=a.childNodes.item(d),f=h.nodeType===3?"value":h.nodeName.replaceArray(b,"").toCamel(),g=xmlToJson(h,b);if(g.length!==0&&f!=="#comment")if(c.hasOwnProperty(f))h.nodeType===3?c[f]+=g:(c[f].constructor!==Array&&(c[f]=[c[f]]),c[f].push(g));else if(h.nodeType!==3||g!=="")c[f]=g}}}return c}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},typeof OsciTk=="undefined"&&(OsciTk={}),jQuery(function(){OsciTk.router=Backbone.Router.extend({routes:{"":"root","section/:section_id":"section"},initialize:function(){},root:function(){app.dispatcher.trigger("routedToRoot")},section:function(a){app.dispatcher.trigger("routedToSection",a)},search:function(a){app.dispatcher.trigger("routedToSearch",a)}})}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.templates=="undefined"&&(OsciTk.templates={}),OsciTk.templateManager={get:function(a){return OsciTk.templates[a]===undefined&&$.ajax({async:!1,dataType:"html",url:"js/backbone/templates/"+a+".tpl.html",success:function(b,c,d){OsciTk.templates[a]=_.template(b)}}),OsciTk.templates[a]}},typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.BaseCollection=Backbone.Collection.extend(),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.BaseModel=Backbone.Model.extend(),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.BaseView=Backbone.View.extend({getChildViews:function(){return this.childViews||(this.childViews=[]),this.childViews},addView:function(a,b){return a.parent=this,typeof b=="undefined"?this.$el.append(a.el):this.$el.find(b).append(a.el),this._addViewReference(a),this},removeAllChildViews:function(){if(this.childViews){for(var a=0,b=this.childViews.length;a<b;a++)this.childViews[a].close();this.childViews=[]}return this},removeView:function(a){if(this.childViews)for(var b=0,c=this.childViews.length;b<c;b++)if(a.cid===this.childViews[b].cid){this.childViews.splice(b,1),a.close();break}return this},getChildViewById:function(a){var b;if(this.childViews)for(var c=0,d=this.childViews.length;c<d;c++)if(a===this.childViews[c].cid){b=this.childViews[c];break}return b},getChildViewByIndex:function(a){var b;return this.childViews&&this.childViews[a]&&(b=this.childViews[a]),b},replaceView:function(a,b){return a.parent=this,typeof b=="undefined"?this.$el.html(a.el):this.$el.find(b).html(a.el),this._addViewReference(a),this},changeModel:function(a){return this.model=a,this},close:function(){this.removeAllChildViews(),this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},_addViewReference:function(a){this.childViews||(this.childViews=[]);var b=!1;for(var c=0,d=this.childViews.length;c<d;c++)if(a.cid===this.childViews[c].cid){b=!0;break}b||this.childViews.push(a)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.templates=="undefined"&&(OsciTk.templates={}),OsciTk.templates["account-login"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h2>Login</h2>\n<div class="form-error"></div>\n<form id="account-form">\n\t<label for="username">Username:</label>\n\t<input type="text" id="username" placeholder="Username" />\n\t<label for="password">Password:</label>\n\t<input type="password" id="password" placeholder="Password" />\n\t<button type="button" class="login">Log In</button>\n\t<div><a href="#" class="register">Register an account</a></div>\n</form>';return __p},OsciTk.templates["account-profile"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h2>Profile</h2>\n<h3>"+username+"</h3>\n<h4>"+email+'</h4>\n<div><a href="#" class="logout">Log out</a></div>';return __p},OsciTk.templates["account-register"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<h2>Register</h2>\n<div class="form-error"></div>\n<form id="account-form">\n\t<label for="username">Username:</label>\n\t<input type="text" id="username" placeholder="Username" />\n\t<label for="password">Password:</label>\n\t<input type="password" id="password" placeholder="Password" />\n\t<label for="email">Email:</label>\n\t<input type="text" id="email" placeholder="Email" />\n\t<button type="button" class="register">Register</button>\n\t<div><a href="#" class="login">Already have an account?</a></div>\n</form>';return __p},OsciTk.templates["figure-reference"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#'+id+'" class="figure_reference">'+title+"</a>";return __p},OsciTk.templates.figures=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='figure-browser'>\n\t<h2>Figures</h2>\n\t<div class='figure-tray'>\n\t\t<div class='figure-reel'>\n\t\t\t",_.each(figures,function(a){__p+="\n\t\t\t\t<figure class='thumbnail' data-figure-id=\""+a.id+"\">\n\t\t\t\t\t<div class='figure-thumbnail' style=\"background-image: url('"+a.thumbnail_url+"');\" >&nbsp;</div>\n\t\t\t\t\t<figcaption>"+a.title+"</figcaption>\n\t\t\t\t</figure>\n\t\t\t"}),__p+="\n\t\t</div>\n\t</div>\n</div>\n<div class='figure-previews'>\n\t<div class='figure-nav prev' title='Previous figure'>&lt;</div>\n\t<div class='figure-nav next' title='Next Figure'>&gt;</div>\n\n\t<h2><span class='back-to-grid'>&laquo; Figures</span> | <span class='title'>Fig x.y - Figure title text?</span></h2>\n\t<div class='figure-tray'>\n\t\t<div class='figure-reel'>\n\t\t\t",_.each(figures,function(a){__p+="\n\t\t\t\t<figure class='preview' data-figure-id=\""+a.id+"\">\n\t\t\t\t\t<div class='figure-preview' style=\"background-image: url('"+a.preview_url+"');\" >&nbsp;</div>\n\t\t\t\t\t<div class='figure-info'>\n\t\t\t\t\t\t<h3 class='title'>Figure Title Here</h3>\n\t\t\t\t\t\t<p class='meta-info'>meta info | more meta info</p>\n\t\t\t\t\t\t<p class='description'>\n\t\t\t\t\t\tFirst, I believe that this nation should commit itself to achieving the goal, before this decade is out, of landing a man on the moon and returning him safely to the earth. No single space project in this period will be more impressive to mankind, or more important for the long-range exploration of space; and none will be so difficult or expensive to accomplish.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</figure>\n\t\t\t"}),__p+="\n\t\t</div>\n\t</div>\n</div>";return __p},OsciTk.templates.font=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="font-control"><span class="large">+A</span> <span class="small">-A</span></div>';return __p},OsciTk.templates["multi-column-column"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="column"></div>';return __p},OsciTk.templates.navigation=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<p>navigation goes here "+numPages+"<p>";return __p},OsciTk.templates.notes=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h2>Notes</h2>\n<ul>\n\t",_.each(notes,function(a){__p+="\n\t\t<li>\n\t\t\t<p>P#"+a.paragraph_id+" - "+a.note+"<br>\n\t\t\t",a.tags.length>0&&(__p+="\n\t\t\t\t<small>tags: ",_.each(a.tags,function(a){__p+=""+a+" "}),__p+="</small>\n\t\t\t"),__p+="\n\t\t\t</p>\n\t\t</li>\n\t"}),__p+="\n</ul>";return __p},OsciTk.templates.page=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+=""+content+"";return __p},OsciTk.templates["search-result"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="search-result-title">'+title+'</div>\n<div class="search-result-type type-'+type+'">'+type+'</div>\n<div class="search-result-content">'+content+"</div>";return __p},OsciTk.templates["search-results"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="search-summary">Result(s) for "'+keyword+'" ('+result_count+')</div>\n<div id="search-sort">\n\tSort By: \n\t<div id="search-sort-relevance" data-selected="0">Relevance</div>\n\t<div id="search-sort-type" data-selected="0">Type</div>\n</div>\n<div id="search-results">'+search_results+"</div>";return __p},OsciTk.templates.search=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="search-header">\n\t<div id="search-box">\n\t\t<form id="search-form" name="search-form" method="POST">\n\t\t\t<input type="text" name="keyword" id="search-keyword" placeholder="search" value="'+query+'"/>\n\t\t\t<input type="hidden" name="page" id="search-page" />\n\t\t</form>\n\t</div>\n</div>\n',searchResults.length>0&&(__p+='\n\t<div id="search-summary">Result(s) for "'+searchResults.keyword+'" ('+searchResults.length+')</div>\n\t<div id="search-sort">\n\t\tSort By: \n\t\t<div id="search-sort-relevance" data-selected="0">Relevance</div>\n\t\t<div id="search-sort-type" data-selected="0">Type</div>\n\t</div>\n\t<div id="search-results">\n\t\t<ul>\n\t\t\t',_.each(searchResults.models,function(a){__p+="\n\t\t\t\t",a.get("bundle")==="note"?__p+="\n\t\t\t\t\t<li>\n\t\t\t\t\t\t"+a.get("bundle_name")+" \n\t\t\t\t\t\tsec."+a.get("im_field_section")[0]+" p."+a.get("is_paragraph_id")+" - \n\t\t\t\t\t\t"+a.get("ss_body")+"\n\t\t\t\t\t</li>\n\t\t\t\t":__p+="\n\t\t\t\t\t<li>"+a.get("bundle_name")+" - "+a.get("ss_body")+"</li>\n\t\t\t\t",__p+="\n\t\t\t"}),__p+="\n\t\t</ul>\n\t</div>\n"),__p+="";return __p},OsciTk.templates.toc=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<h2>Table of Contents</h2>\n<ul>\n\t",_.each(items,function(a){__p+='\n\t\t<li class="toc-item">\n\t\t\t<a data-section-id="'+a.id+'">\n\t\t\t\t<div class="toc-item-thumbnail">\n\t\t\t\t\t',a.get("thumbnail")&&(__p+='\n\t\t\t\t\t\t<img src="'+a.get("thumbnail")+'">\n\t\t\t\t\t'),__p+='\n\t\t\t\t</div>\n\t\t\t\t<div class="toc-item-text">\n\t\t\t\t\t<h4>'+a.get("title")+"</h4>\n\t\t\t\t\t",a.get("subtitle")&&(__p+="\n\t\t\t\t\t\t<h5>"+a.get("subtitle")+"</h5>\n\t\t\t\t\t"),__p+="\n\t\t\t\t</div>\n\t\t\t</a>\n\t\t</li>\n\t"}),__p+="\n</ul>";return __p},OsciTk.templates["toolbar-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+=""+text+"";return __p},OsciTk.templates.toolbar=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="toolbar-close">Close</div>\n<div id="toolbar-content"></div>\n<div id="toolbar-handle"></div>';return __p},typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Account=OsciTk.models.BaseModel.extend({defaults:{username:"anonymous",id:0},initialize:function(){this.getSessionState()},sync:function(a,b,c){console.log(a,"account sync")},getSessionState:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"status"},type:"POST",dataType:"json",success:function(b){b.success===!0&&a.set(b.user)}})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Config=OsciTk.models.BaseModel.extend({}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Figure=OsciTk.models.BaseModel.extend({defaults:function(){return{section_id:null,delta:null,caption:null,position:null,columns:null,body:null,options:{}}}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Footnote=OsciTk.models.BaseModel.extend({defaults:function(){return{body:"",section_id:"",delta:""}},sync:function(a,b,c){console.log("Footnote.sync: "+a)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.NavigationItem=OsciTk.models.BaseModel.extend({defaults:function(){return{title:null,subtitle:null,uri:null,parent:null,next:null,previous:null,depth:0,thumbnail:null,timestamp:null}},initialize:function(){}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Note=OsciTk.models.BaseModel.extend({defaults:function(){return{id:null,note:null,section_id:null,paragraph_id:null,tags:[]}},initialize:function(a,b){this.bind("error",function(a,b){console.log([a,b],"error fired")})},sync:function(a,b,c){var d=app.config.get("endpoints").OsciTkNote;console.log("Note.sync: "+a),console.log(b,"model"),console.log(c,"options"),a=="create"&&(c.data=this.urlFormEncode(b),c.success=function(a,d,e){var f=JSON.parse(a);f.success||c.error(b,e)},c.type="POST",$.ajax(d,c)),a=="update"&&(c.data=this.urlFormEncode(b),c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"update response"),f.success||c.error(b,e)},c.type="POST",$.ajax(d,c)),a=="delete"&&(c.data=this.urlFormEncode(b),c.data=c.data+"delete=1",c.type="POST",c.success=function(a,d,e){var f=JSON.parse(a);console.log(f,"delete response"),f.success||c.error(b,e)},$.ajax(d,c))},urlFormEncode:function(a){var b="";for(var c in a.attributes)if($.isArray(a.attributes[c]))for(var d in a.attributes[c])b=b+c+"[]="+a.attributes[c][d]+"&";else b=b+c+"="+a.attributes[c]+"&";return b}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Package=OsciTk.models.BaseModel.extend({defaults:function(){return{url:null,lang:null,spine:null,manifest:null,metadata:null,id:null,version:null,xmlns:null}},initialize:function(){var a=xmlToJson(loadXMLDoc(this.get("url")));this.set("lang",a["package"].lang),this.set("spine",a["package"].spine),this.set("manifest",a["package"].manifest),this.set("metadata",a["package"].metadata),this.set("id",a["package"]["unique-identifier"]),this.set("version",a["package"].version),this.set("xmlns",a["package"].xmlns),app.dispatcher.trigger("packageLoaded",this)},sync:function(a,b,c){console.log("Package.sync: "+a)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Page=OsciTk.models.BaseModel.extend({defaults:function(){return{content:[]}},addContent:function(a){var b=this.get("content");return b.push(a),this},removeContentAt:function(a){var b=this.get("content");return b.splice(a,1),this}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.SearchResult=OsciTk.models.BaseModel.extend({}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.models=="undefined"&&(OsciTk.models={}),OsciTk.models.Section=OsciTk.models.BaseModel.extend({idAttribute:"data-section_id",defaults:function(){return{title:null,content:null,uri:null,media_type:"application/xhtml+xml",contentLoaded:!1,pages:new OsciTk.collections.Pages}},sync:function(a,b,c){},parse:function(a){console.log("parse section")},loadContent:function(){var a=null;if(this.get("contentLoaded")===!1){var b=loadXMLDoc(this.get("uri"));a=$(b),this.set("title",b.title),this.set("content",a),this.set("contentLoaded",!0)}a===null&&(a=$(this.get("content")));var c=a.find("section#footnotes"),d=a.find("figure");app.dispatcher.trigger("footnotesAvailable",c),app.dispatcher.trigger("figuresAvailable",d),app.dispatcher.trigger("sectionLoaded",this)},removeAllPages:function(){this.set("pages",new OsciTk.collections.Pages)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Figures=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Figure,initialize:function(){app.dispatcher.bind("figuresAvailable",function(a){console.log("figuresAvailable",a),this.populateFromMarkup(a)},this)},comparator:function(a){return a.get("delta")},populateFromMarkup:function(a){_.each(a,function(a){var b=a.id.match(/\w+-(\d+)-(\d+)/),c={id:a.id,rawData:a,body:a.innerHTML,section_id:b[1],delta:b[2],title:$(a).attr("title"),caption:$("figcaption",a).html(),position:$(a).attr("data-position"),columns:$(a).attr("data-columns"),options:JSON.parse($(a).attr("data-options")),thumbnail_url:null,preview_url:null},d=$(a).children("img.thumbnail");if(d.length)c.thumbnail_url=d.attr("src"),c.preview_url=d.attr("src");else{var e=$(".figure_content img",a);e.length&&(c.thumbnail_url=e.attr("src"),c.preview_url=e.attr("src"))}this.add(c)},this)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Footnotes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Footnote,initialize:function(){app.dispatcher.bind("footnotesAvailable",function(a){this.populateFromMarkup(a)},this)},populateFromMarkup:function(a){_.each($("aside",a),function(a){var b=a.id.match(/\w+-(\d+)-(\d+)/),c={id:a.id,rawData:a,body:a.innerHTML,section_id:b[1],delta:b[2]};this.add(c)},this)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.NavigationItems=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.NavigationItem,currentNavigationItem:null,initialize:function(){app.dispatcher.on("packageLoaded",function(a){var b=_.find(a.get("manifest").item,function(a){return a.properties=="nav"});if(b){var c=xmlToJson(loadXMLDoc(b.href)),d=c.html[1].body.nav;for(var e in d)if(d[e].type=="toc"){_.each(d[e].ol.li,function(a){this.parseChildren(a,null,0)},this);break}app.dispatcher.trigger("navigationLoaded",this)}},this),app.dispatcher.on("routedToRoot",function(){this.goToBeginning()},this),app.dispatcher.on("routedToSection",function(a){this.setCurrentNavigationItem(this.get(a))},this)},getCurrentNavigationItem:function(){return this.currentNavigationItem},setCurrentNavigationItem:function(a){this.currentNavigationItem=a,app.dispatcher.trigger("currentNavigationItemChanged")},goToBeginning:function(){this.at(0)&&this.setCurrentNavigationItem(this.at(0))},parseChildren:function(a,b,c){var d={id:a.a["data-section_id"],parent:b,depth:c,previous:this.at(this.length-1),next:undefined,length:a.a["data-length"],title:a.a.value,subtitle:a.a["data-subtitle"],thumbnail:a.a["data-thumbnail"],timestamp:a.a["data-timestamp"],uri:a.a.href};this.add(d);var e=this.at(this.length-1);e.get("previous")!==undefined&&e.get("previous").set("next",e);if(a.ol&&a.ol.li){var f;typeof a.ol.li.length!="undefined"?f=a.ol.li:f=[a.ol.li],_.each(f,function(a){this.parseChildren(a,e,++c)},this)}}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Notes=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Note,initialize:function(){this.on("change",function(){app.dispatcher.trigger("notesChanged")}),app.dispatcher.on("currentNavigationItemChanged",function(a){var b=app.collections.navigationItems.getCurrentNavigationItem();b.id&&app.collections.notes.getNotesForSection(b.id)},this)},parse:function(a){return a.success?a.notes:!1},getNotesForSection:function(a){$.ajax({url:app.config.get("endpoints").OsciTkNotes,data:{section_id:a},type:"GET",dataType:"json",success:function(a){a.success===!0&&app.collections.notes.reset(a.notes)}})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page,initialize:function(){}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.SearchResults=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.SearchResult}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.collections=="undefined"&&(OsciTk.collections={}),OsciTk.collections.Pages=OsciTk.collections.BaseCollection.extend({model:OsciTk.models.Page}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Page=OsciTk.views.BaseView.extend({template:OsciTk.templateManager.get("page"),className:"page",initialize:function(){this.processingData={complete:!1},this.$el.addClass("page-num-"+this.model.collection.length).attr("data-page_num",this.model.collection.length)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},processingComplete:function(){return this.processingData.complete=!0,this},addContent:function(a){return this.model.addContent(a),this},hasContent:function(a){return this.model.get("content").length?!0:!1},isPageComplete:function(){return this.processingData.complete}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Section=OsciTk.views.BaseView.extend({id:"section",initialize:function(){_.defaults(this.options,{pageView:"Page"}),app.dispatcher.on("currentNavigationItemChanged",function(){if(app.collections.navigationItems.getCurrentNavigationItem()){var a=app.collections.navigationItems.getCurrentNavigationItem();app.models.section=new OsciTk.models.Section({uri:a.get("uri")}),app.models.section.loadContent(),this.changeModel(app.models.section),this.removeAllChildViews(),this.render()}},this)},render:function(){return app.dispatcher.trigger("layoutStart"),this.renderContent(),app.dispatcher.trigger("layoutComplete",{numPages:this.model.get("pages").length}),this},onClose:function(){this.model.removeAllPages()},getPageForProcessing:function(a){var b;return a!==undefined?b=this.getChildViewById(a):(b=_.filter(this.getChildViews(),function(a){return a.isPageComplete()===!1}),b.length===0?(this.model.get("pages").add({}),b=new OsciTk.views[this.options.pageView]({model:this.model.get("pages").at(this.model.get("pages").length-1)}),this.addView(b)):b=b.pop()),b},renderContent:function(){var a=this.getPageForProcessing();a.addContent(this.model.get("content").find("body").html()),a.render(),a.processingComplete()}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Account=OsciTk.views.BaseView.extend({className:"account-view",template:null,initialize:function(){this.model=app.account},render:function(){this.model.get("id")>0?this.showProfile():this.showLoginForm()},events:{"click button.login":"login","click button.register":"register","click a.register":"showRegistrationForm","click a.login":"showLoginForm","click a.logout":"logout"},login:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"login",username:b,password:c},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},logout:function(){var a=this;$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"logout"},type:"POST",dataType:"json",success:function(b){a.model.set(b.user),a.showLoginForm()}})},register:function(){var a=this,b=this.$el.find("#username").val(),c=this.$el.find("#password").val(),d=this.$el.find("#email").val();$.ajax({url:app.config.get("endpoints").OsciTkAccount,data:{action:"register",username:b,password:c,email:d},type:"POST",dataType:"json",success:function(b){b.success===!0?(a.model.set(b.user),a.showProfile()):a.$el.find("div.form-error").html(b.error)}})},showRegistrationForm:function(){this.template=OsciTk.templateManager.get("account-register"),this.$el.html(this.template())},showLoginForm:function(){this.template=OsciTk.templateManager.get("account-login"),this.$el.html(this.template())},showProfile:function(){this.template=OsciTk.templateManager.get("account-profile"),this.$el.html(this.template(this.model.toJSON()))}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.App=OsciTk.views.BaseView.extend({id:"reader",initialize:function(){$("body").append(this.el),app.views.toolbarView=new OsciTk.views.Toolbar,this.addView(app.views.toolbarView);var a=OsciTk.views.Section;app.config.get("sectionView")&&OsciTk.views[app.config.get("sectionView")]&&(a=OsciTk.views[app.config.get("sectionView")]);var b={};app.config.get("sectionViewOptions")&&(b=app.config.get("sectionViewOptions")),app.views.sectionView=new a(b),this.addView(app.views.sectionView),app.views.navigationView=new OsciTk.views.Navigation,this.addView(app.views.navigationView)}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Figures=OsciTk.views.BaseView.extend({className:"figures-view",template:OsciTk.templateManager.get("figures"),initialize:function(){app.collections.figures.bind("add remove",function(){this.render()},this)},render:function(){var a=app.collections.figures.toJSON();this.$el.html(this.template({figures:a}));if(a.length>1){var b=$("#toolbar figure.thumbnail");$("#toolbar .figure-browser .figure-reel").width(b.length*b.outerWidth(!0))}return $("#toolbar figure.thumbnail").click(function(){$("#toolbar .figure-browser").hide(),$("#toolbar .figure-previews figure.active").hide().removeClass("active");var a=$("#toolbar figure.preview[data-figure-id='"+$(this).attr("data-figure-id")+"']");a.show().addClass("active"),OsciTk.views.Figures.prototype.displayTitle(),$("#toolbar .figure-previews").show(),$("#toolbar").animate({height:$("#toolbar-content").height()+$("#toolbar-handle").height()},"fast")}),$(".back-to-grid").click(function(){$("#toolbar").animate({height:$(".figure-browser").height()+$("#toolbar-handle").height()},"fast",function(){$("#toolbar .figure-previews").hide(),$("#toolbar .figure-browser").show()})}),$("#toolbar .figure-nav.next").click(function(){var a=$("#toolbar figure.preview.active").hide().removeClass("active").next("figure.preview");a.length===0&&(a=$("#toolbar figure.preview").first()),a.show().addClass("active"),OsciTk.views.Figures.prototype.displayTitle()}),$("#toolbar .figure-nav.prev").click(function(){var a=$("#toolbar figure.preview.active").hide().removeClass("active").prev("figure.preview");a.length===0&&(a=$("#toolbar figure.preview").last()),a.show().addClass("active"),OsciTk.views.Figures.prototype.displayTitle()}),this},displayTitle:function(){var a=$("#toolbar figure.preview.active").attr("data-figure-id"),b=app.collections.figures.get(a);$("#toolbar h2 span.title").html(b.get("title"))}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Font=OsciTk.views.BaseView.extend({className:"font-view",template:OsciTk.templateManager.get("font"),initialize:function(){this.render()},render:function(){this.$el.html(this.template())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.MultiColumnPage=OsciTk.views.Page.extend({columnTemplate:OsciTk.templateManager.get("multi-column-column"),onClose:function(){this.model=undefined},render:function(){if(this.processingData.rendered)return this;this.$el.css({width:this.parent.dimensions.innerPageWidth,height:this.parent.dimensions.innerPageHeight}),this.processingData.columns=[];for(var a=0;a<this.parent.dimensions.columnsPerPage;a++)this.processingData.columns[a]={height:this.parent.dimensions.innerPageHeight,heightRemain:this.parent.dimensions.innerPageHeight,$el:null,offset:0};return this.processingData.currentColumn=0,this.processingData.rendered=!0,this},layoutContent:function(){var a=this.getCurrentColumn(),b=$(this.model.get("content")[this.model.get("content").length-1]);a.$el.append(b);var c=parseFloat(b.css("line-height"));if(a.height-b.position().top<c)return b.remove(),a.heightRemain=0,!0;var d=b.outerHeight(!0),e=0;a.offset<0&&(e=d+a.offset,b.css("margin-top","-"+e+"px"),a.offset=0);var f=b.find("a.figure_reference:not(.processed)");!f.length;var g={top:parseInt(b.css("margin-top"),10),bottom:parseInt(b.css("margin-bottom"),10)},h=a.heightRemain-b.outerHeight(!0);h>0&&h<c?h=0:h<0&&h>=g.bottom*-1&&(h=0);var i=!1;if(h<0){var j=h,k=Math.ceil(j/c),l=b.position().top+b.outerHeight()+k*c;a.height=l,a.$el.height(l+"px"),k===0?(h=0,i=!1):(h=k*c-g.bottom,i=!0),this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete()}return h===0&&this.processingData.currentColumn===this.parent.dimensions.columnsPerPage-1&&this.processingComplete(),a.heightRemain=h,i},getCurrentColumn:function(){var a=null;if(this.processingData.columns[this.processingData.currentColumn]&&this.processingData.columns[this.processingData.currentColumn].heightRemain>0)a=this.processingData.columns[this.processingData.currentColumn];else for(var b=0;b<this.parent.dimensions.columnsPerPage;b++)if(this.processingData.columns[b].heightRemain>0){a=this.processingData.columns[b],this.processingData.currentColumn=b;break}if(a!==null&&a.$el===null){if(this.processingData.currentColumn>0)a.offset=this.processingData.columns[this.processingData.currentColumn-1].heightRemain;else{var c=this.parent.getChildViewByIndex(this.parent.getChildViews().length-2);c&&(a.offset=c.processingData.columns[c.processingData.columns.length-1].heightRemain)}var d={width:this.parent.dimensions.columnWidth+"px",height:a.height+"px",left:this.processingData.currentColumn*this.parent.dimensions.columnWidth+this.parent.dimensions.gutterWidth*this.processingData.currentColumn};a.$el=$(this.columnTemplate()).appendTo(this.$el).addClass("column-"+this.processingData.currentColumn).css(d)}return a}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.MultiColumnSection=OsciTk.views.Section.extend({initialize:function(){this.options.pageView="MultiColumnPage",app.dispatcher.on("windowResized",function(){this.removeAllChildViews(),this.model.removeAllPages(),this.render()},this),this.$el.addClass("oscitk_multi_column"),_.defaults(this.options,{minColumnWidth:200,maxColumnWidth:300,gutterWidth:40,minLinesPerColumn:5}),this.dimensions={},OsciTk.views.MultiColumnSection.__super__.initialize.call(this)},renderContent:function(){this.calculateDimensions(),this.layoutData={data:this.model.get("content"),items:null},this.cleanData(),this.layoutData.items=this.layoutData.data.length;var a=0;while(this.layoutData.items>0){var b=this.getPageForProcessing();b.processingData.rendered||b.render();var c=b.addContent($(this.layoutData.data[a]).clone()).layoutContent();c||(a++,this.layoutData.items--)}},calculateDimensions:function(){var a=this.dimensions,b=$(window).width(),c=$(window).height();if(a.windowWidth&&a.windowWidth===b&&a.windowHeight&&a.windowHeight===c)return;a.windowHeight=c,a.windowWidth=b,a.gutterWidth=this.options.gutterWidth,a.pageMargin={left:parseInt(this.$el.css("margin-left"),10),top:parseInt(this.$el.css("margin-top"),10),right:parseInt(this.$el.css("margin-right"),10),bottom:parseInt(this.$el.css("margin-bottom"),10)},a.pagePadding={left:parseInt(this.$el.css("padding-left"),10),top:parseInt(this.$el.css("padding-top"),10),right:parseInt(this.$el.css("padding-right"),10),bottom:parseInt(this.$el.css("padding-bottom"),10)},a.outerPageHeight=c-a.pageMargin.top-a.pageMargin.bottom,a.innerPageHeight=a.outerPageHeight-a.pagePadding.top-a.pagePadding.bottom,a.outerPageWidth=this.$el.outerWidth(),a.innerPageWidth=a.outerPageWidth-a.pagePadding.left-a.pagePadding.right,a.innerPageWidth<this.options.maxColumnWidth?a.columnWidth=a.innerPageWidth:a.columnWidth=this.options.maxColumnWidth,a.columnsPerPage=Math.floor(a.innerPageWidth/a.columnWidth),a.innerPageWidth<a.columnsPerPage*a.columnWidth+(a.columnsPerPage-1)*this.options.gutterWidth&&(a.columnsPerPage=a.columnsPerPage-1);var d=(a.innerPageWidth-a.columnsPerPage*a.columnWidth)/(a.columnsPerPage-1);d>this.options.gutterWidth&&(a.columnWidth=(a.innerPageWidth-this.options.gutterWidth*(a.columnsPerPage-1))/a.columnsPerPage),this.dimensions=a},cleanData:function(){this.layoutData.data.find("#figures").remove(),this.layoutData.data.find("#footnotes").remove();var a=this.layoutData.data.find("figure");if(a.length){var b=OsciTk.templateManager.get("figure-reference");for(var c=0,d=a.length;c<d;c++){var e=$(a[c]),f={id:e.attr("id"),title:e.attr("title")};e.replaceWith(b(f))}}this.layoutData.data=this.layoutData.data.find("section").children()}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Navigation=OsciTk.views.BaseView.extend({id:"navigation",template:OsciTk.templateManager.get("navigation"),initialize:function(){app.dispatcher.on("layoutComplete",function(a){this.numPages=a.numPages,this.render()},this)},render:function(){this.$el.html(this.template({numPages:this.numPages}))}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Notes=OsciTk.views.BaseView.extend({className:"notes-view",template:OsciTk.templateManager.get("notes"),initialize:function(){app.collections.notes.bind("add remove",function(){this.render()},this)},render:function(){return this.$el.html(this.template({notes:app.collections.notes.toJSON()})),this}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.SearchResults=OsciTk.views.BaseView.extend({id:"search-results-container",template:OsciTk.templateManager.get("search-results"),initialize:function(a){console.log(a),this.searchResults=new OsciTk.collections.SearchResults({docs:a.docs}),this.render()},render:function(){this.$el.html(this.template())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.SearchResult=OsciTk.views.BaseView.extend({id:"search-results-container",template:OsciTk.templateManager.get("search-result"),initialize:function(a){this.render()},render:function(){this.$el.html(this.template())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Search=OsciTk.views.BaseView.extend({id:"search-view",className:"toolbar-item-view",template:OsciTk.templateManager.get("search"),searchResults:new OsciTk.collections.SearchResults,page:0,query:"",filters:null,sort:null,initialize:function(){app&&app.collections&&(app.collections.searchResults=this.searchResults)},events:{"submit #search-form":"search"},render:function(){this.$el.html(this.template(this))},search:function(a){a.preventDefault();var b=this.query=this.$el.find("#search-keyword").val(),c=this;$.ajax({url:app.config.get("endpoints").OsciTkSearch+"?key="+b+"&filters=type:note",type:"POST",success:function(a){var d=JSON.parse(a);_.each(d.docs,function(a){c.searchResults.add(a)}),c.searchResults.keyword=b,c.render(),c.parent.contentOpen()}})}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Toc=OsciTk.views.BaseView.extend({className:"toc-view",template:OsciTk.templateManager.get("toc"),events:{"click li a":"itemClick"},initialize:function(){this.parent=this.options.parent},render:function(){this.$el.html(this.template({items:app.collections.navigationItems.where({depth:0})}))},itemClick:function(a){var b=$(a.currentTarget).attr("data-section-id");app.router.navigate("section/"+b,{trigger:!0}),this.parent.contentClose()}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.ToolbarItem=OsciTk.views.BaseView.extend({className:"toolbar-item",template:OsciTk.templateManager.get("toolbar-item"),initialize:function(){this.$el.addClass(this.options.toolbarItem.view+"-toolbar-item"),this.contentView=null,this.contentViewRendered=!1},events:{click:"itemClicked",touch:"itemClicked"},render:function(){this.contentView=new OsciTk.views[this.options.toolbarItem.view]({parent:this}),this.parent.addView(this.contentView,"#toolbar-content"),this.$el.html(this.template({text:this.options.toolbarItem.text}))},itemClicked:function(){this.contentViewRendered||(this.contentView.render(),this.contentViewRendered=!0);var a;this.parent.isContentOpen===!1?(this.parent.activeContentView=this.options.toolbarItem.view,a=this.parent.$el.find("#toolbar-content").children().not("#"+this.contentView.id),_.each(a,function(a){$(a).hide()},this),this.contentView.$el.show(),this.parent.contentOpen()):this.parent.activeContentView==this.options.toolbarItem.view?(this.parent.activeContentView=null,this.parent.contentClose()):(this.parent.activeContentView=this.options.toolbarItem.view,a=this.parent.$el.find("#toolbar-content").children().not("#"+this.contentView.id),_.each(a,function(a){$(a).hide()},this),this.contentView.$el.show(),this.parent.contentOpen())}}),typeof OsciTk=="undefined"&&(OsciTk={}),typeof OsciTk.views=="undefined"&&(OsciTk.views={}),OsciTk.views.Toolbar=OsciTk.views.BaseView.extend({id:"toolbar",template:OsciTk.templateManager.get("toolbar"),initialize:function(){this.toolbarItems=app.config.get("toolbarItems")?app.config.get("toolbarItems"):[],this.toolbarItemViews=[],this.isContentOpen=!1,this.render(),$("#toolbar-close").live("click",function(){app.views.toolbarView.contentClose()})},render:function(){this.$el.html(this.template()),_.each(this.toolbarItems,function(a){var b=new OsciTk.views.ToolbarItem({toolbarItem:a});this.addView(b,"#toolbar-handle"),b.render()},this)},contentOpen:function(){var a=this.$el.find("#toolbar-content"),b=this.$el.find("#toolbar-handle").outerHeight(),c=a.outerHeight()+b,d=parseInt(this.$el.css("max-height"),10),e=$(window).height()*(d/100);c>e&&a.height(e-b),this.$el.animate({height:c+"px"},"fast",function(){$("#toolbar-close").show()}),this.isContentOpen=!0},contentClose:function(){$("#toolbar-close").hide(),this.$el.animate({height:this.$el.find("#toolbar-handle").outerHeight()+"px",width:"100%"},"fast"),this.isContentOpen=!1}}),app={dispatcher:undefined,router:undefined,config:undefined,views:{},models:{},collections:{},bootstrap:function(a){this.dispatcher=_.extend({},Backbone.Events),this.config=new OsciTk.models.Config(a),this.router=new OsciTk.router,this.account=new OsciTk.models.Account,this.collections.notes=new OsciTk.collections.Notes,this.collections.figures=new OsciTk.collections.Figures,this.collections.footnotes=new OsciTk.collections.Footnotes,this.collections.navigationItems=new OsciTk.collections.NavigationItems,window.onresize=function(){window.resizeTimer&&clearTimeout(window.resizeTimer);var a=function(){app.dispatcher.trigger("windowResized")};window.resizeTimer=setTimeout(a,200)},this.views.app=new OsciTk.views.App,this.models.docPackage=new OsciTk.models.Package({url:this.config.get("packageUrl")})},run:function(){Backbone.history.start()}};